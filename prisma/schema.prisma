generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 스포츠 타입 enum
enum SportType {
  FOOTBALL
  BASKETBALL
  BASEBALL
}

// 리그 테이블
model League {
  id              String    @id @default(cuid())
  name            String
  country         String
  sportType       SportType @default(FOOTBALL)
  externalId      String?   // External API competition ID
  code            String?   // Competition code (e.g., "PL", "NBA")
  logoUrl         String?
  season          Int?      // 현재 시즌
  currentMatchday Int?      // 현재 라운드
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  teams   Team[]
  matches Match[]

  @@unique([sportType, externalId])
  @@unique([sportType, code])
  @@index([sportType])
  @@index([country])
  @@index([code])
}

// 팀 테이블
model Team {
  id          String    @id @default(cuid())
  leagueId    String
  name        String
  shortName   String?
  tla         String?   // 3글자 약어 (e.g., "MUN", "ARS")
  logoUrl     String?
  externalId  String?   // External API team ID
  sportType   SportType @default(FOOTBALL)
  founded     Int?
  venue       String?
  city        String?
  clubColors  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  league           League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  players          Player[]
  homeMatches      Match[]            @relation("HomeTeam")
  awayMatches      Match[]            @relation("AwayTeam")
  seasonStats      TeamSeasonStats?   // 시즌 전체 요약 스탯
  recentMatches    TeamRecentMatches? // 최근 경기 목록
  homeH2H          HeadToHead[]       @relation("H2HTeamA")
  awayH2H          HeadToHead[]       @relation("H2HTeamB")

  @@unique([sportType, externalId])
  @@index([leagueId])
  @@index([name])
  @@index([sportType])
}

// 선수 테이블
model Player {
  id              String    @id @default(cuid())
  teamId          String
  name            String
  firstName       String?
  lastName        String?
  position        String?   // Goalkeeper, Defence, Midfield, Offence
  nationality     String?
  birthDate       DateTime?
  shirtNumber     Int?
  photoUrl        String?
  marketValue     Int?      // 시장 가치 (유로)
  contractStart   DateTime?
  contractEnd     DateTime?
  externalId      String?   @unique  // Football-Data.org person ID
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([name])
  @@index([position])
}

// 경기 상태 enum (Football-Data.org 상태와 매핑)
enum MatchStatus {
  SCHEDULED   // 예정
  TIMED       // 시간 확정
  LIVE        // 진행 중 (IN_PLAY, PAUSED)
  FINISHED    // 종료
  POSTPONED   // 연기
  CANCELLED   // 취소
  SUSPENDED   // 중단
}

// 경기 테이블
model Match {
  id            String      @id @default(cuid())
  leagueId      String
  homeTeamId    String
  awayTeamId    String
  sportType     SportType   @default(FOOTBALL)
  kickoffAt     DateTime
  status        MatchStatus @default(SCHEDULED)
  homeScore     Int?
  awayScore     Int?
  halfTimeHome  Int?        // 전반전 홈 스코어
  halfTimeAway  Int?        // 전반전 원정 스코어
  matchday      Int?        // 라운드 번호
  round         String?     // 라운드 문자열 (예: "Regular Season - 20")
  stage         String?     // 스테이지 (예: "GROUP_STAGE", "FINAL")
  venue         String?
  slug          String?     @unique
  externalId    String?     // External API match ID
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  league        League         @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  homeTeam      Team           @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeam      Team           @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  matchStats    MatchStats?
  matchAnalysis MatchAnalysis?

  @@unique([sportType, externalId])
  @@index([leagueId])
  @@index([kickoffAt])
  @@index([status])
  @@index([homeTeamId])
  @@index([awayTeamId])
  @@index([sportType])
  @@index([matchday])
}

// 경기 스탯 테이블 (실시간/캐시용)
model MatchStats {
  id        String   @id @default(cuid())
  matchId   String   @unique
  statsJson Json     // 경기 스탯 JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
}

// 팀 시즌 스탯 테이블 (시즌 전체 요약)
model TeamSeasonStats {
  id               String    @id @default(cuid())
  teamId           String    @unique
  sportType        SportType @default(FOOTBALL)
  season           Int       // 시즌 년도

  // 공통 필드
  gamesPlayed      Int       @default(0)
  wins             Int       @default(0)
  draws            Int?      // 축구만 해당
  losses           Int       @default(0)
  rank             Int?      // 리그 순위

  // 축구용 필드
  points           Int?      // 승점 (축구)
  goalsFor         Int?      // 득점 (축구)
  goalsAgainst     Int?      // 실점 (축구)
  goalDifference   Int?      // 골득실차
  form             String?   // 최근 폼 (예: "W,W,D,L,W")

  // 농구/야구 공통
  pointsScored     Float?    // 평균 득점 (농구/야구)
  pointsAllowed    Float?    // 평균 실점 (농구/야구)

  // 홈/원정 성향
  homeGames        Int       @default(0)
  homeWins         Int       @default(0)
  homeDraws        Int?
  homeLosses       Int?
  homeGoalsFor     Int?
  homeGoalsAgainst Int?
  homeAvgFor       Float?    // 홈 평균 득점
  homeAvgAgainst   Float?    // 홈 평균 실점

  awayGames        Int       @default(0)
  awayWins         Int       @default(0)
  awayDraws        Int?
  awayLosses       Int?
  awayGoalsFor     Int?
  awayGoalsAgainst Int?
  awayAvgFor       Float?    // 원정 평균 득점
  awayAvgAgainst   Float?    // 원정 평균 실점

  // 추가 스탯 (JSON으로 유연하게)
  additionalStats  Json?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([sportType])
  @@index([season])
}

// 팀 최근 경기 목록 테이블
model TeamRecentMatches {
  id           String    @id @default(cuid())
  teamId       String    @unique
  sportType    SportType @default(FOOTBALL)
  matchesJson  Json      // 최근 10~15경기 저장 [{date, opponent, result, score, isHome}, ...]
  recentForm   String?   // 최근 5경기 폼 (예: "WWDLW")
  updatedAt    DateTime  @updatedAt
  createdAt    DateTime  @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([sportType])
}

// 상대전적 테이블
model HeadToHead {
  id           String    @id @default(cuid())
  teamAId      String
  teamBId      String
  sportType    SportType @default(FOOTBALL)
  matchesJson  Json      // 최근 맞대결 경기 목록 [{date, result, score}, ...]
  updatedAt    DateTime  @updatedAt
  createdAt    DateTime  @default(now())

  teamA Team @relation("H2HTeamA", fields: [teamAId], references: [id], onDelete: Cascade)
  teamB Team @relation("H2HTeamB", fields: [teamBId], references: [id], onDelete: Cascade)

  @@unique([teamAId, teamBId])
  @@index([sportType])
}

// AI 경기 분석 테이블
model MatchAnalysis {
  id                  String   @id @default(cuid())
  matchId             String   @unique

  // 다국어 번역본 통합 저장 (확장성)
  // 구조: { "en": { "summary": "...", ... }, "ko": { ... }, "es": { ... }, "ja": { ... }, "ar": { ... } }
  translations        Json?

  // 하위 호환성을 위한 기존 필드 (당분간 유지)
  summary             String?  @db.Text
  recentFlowAnalysis  String?  @db.Text
  seasonTrends        String?  @db.Text
  tacticalAnalysis    String?  @db.Text
  keyPoints           Json?

  summaryEn           String?  @db.Text
  recentFlowAnalysisEn String? @db.Text
  seasonTrendsEn      String?  @db.Text
  tacticalAnalysisEn  String?  @db.Text
  keyPointsEn         Json?

  inputDataSnapshot   Json?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
}

// 데일리 리포트 테이블
model DailyReport {
  id         String    @id @default(cuid())
  date       DateTime  @db.Date
  sportType  SportType @default(FOOTBALL)

  // 다국어 번역본 통합 저장
  // 구조: { "en": { "title": "...", "summary": "...", ... }, "ko": { ... }, ... }
  translations Json?

  summary    String    @db.Text
  summaryEn  String?   @db.Text
  hotMatches Json?     // 주목 경기 목록
  keyNews    Json?     // 핵심 뉴스
  insights   Json?     // 인사이트
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([date, sportType])
  @@index([date])
  @@index([sportType])
}

// 뉴스 테이블
model News {
  id           String    @id @default(cuid())
  title        String
  titleEn      String?
  
  // 다국어 번역본 통합 저장
  translations Json?

  link         String    @unique
  summary      String    @db.Text
  summaryEn    String?   @db.Text
  relatedTeams Json?     // 관련 팀 ID 목록
  sportType    SportType @default(FOOTBALL)
  imageUrl     String?
  source       String?
  publishedAt  DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([publishedAt])
  @@index([sportType])
}

// 스케줄러 로그 테이블
model SchedulerLog {
  id         String   @id @default(cuid())
  jobName    String
  executedAt DateTime @default(now())
  result     String   // 'success' | 'failed' | 'partial'
  details    Json?    // 상세 결과
  duration   Int?     // 실행 시간 (ms)
  apiCalls   Int?     // API 호출 횟수
  createdAt  DateTime @default(now())

  @@index([jobName])
  @@index([executedAt])
}

// API 호출 추적 테이블 (Free Plan 제한 관리용)
model ApiCallLog {
  id         String    @id @default(cuid())
  apiType    String    // 'football' | 'basketball' | 'baseball'
  endpoint   String    // 호출한 엔드포인트
  calledAt   DateTime  @default(now())
  success    Boolean   @default(true)
  response   Json?     // 응답 요약 (선택)

  @@index([apiType])
  @@index([calledAt])
}
