name: Data Collection Cron Jobs

on:
  schedule:
    # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC 01:00, 07:00, 13:00, 19:00 = KST 10:00, 16:00, 22:00, 04:00)
    # GitHub Actions ìŠ¤ì¼€ì¤„ ì‹ ë¢°ì„± ë¬¸ì œë¡œ ë” ìžì£¼ ì‹¤í–‰
    - cron: '0 1,7,13,19 * * *'
  workflow_dispatch:
    inputs:
      sport:
        description: 'Sport to collect data for'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - football
          - basketball
          - baseball

jobs:
  # =====================================================
  # FOOTBALL JOBS - ë¦¬ê·¸ë³„ ë¶„ë¦¬ (íƒ€ìž„ì•„ì›ƒ ë°©ì§€)
  # =====================================================
  football-pl:
    name: Football - Premier League
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.sport == 'football' || github.event.inputs.sport == 'all') ||
      github.event_name == 'schedule'
    steps:
      - name: Collect Premier League
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-football?league=PL" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

  football-laliga:
    name: Football - La Liga
    runs-on: ubuntu-latest
    needs: [football-pl]
    if: |
      always() &&
      (needs.football-pl.result == 'success' || needs.football-pl.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'football' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 10

      - name: Collect La Liga
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-football?league=PD" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

  football-seriea:
    name: Football - Serie A
    runs-on: ubuntu-latest
    needs: [football-laliga]
    if: |
      always() &&
      (needs.football-laliga.result == 'success' || needs.football-laliga.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'football' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 10

      - name: Collect Serie A
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-football?league=SA" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

  football-bundesliga:
    name: Football - Bundesliga
    runs-on: ubuntu-latest
    needs: [football-seriea]
    if: |
      always() &&
      (needs.football-seriea.result == 'success' || needs.football-seriea.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'football' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 10

      - name: Collect Bundesliga
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-football?league=BL1" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

  football-ligue1:
    name: Football - Ligue 1
    runs-on: ubuntu-latest
    needs: [football-bundesliga]
    if: |
      always() &&
      (needs.football-bundesliga.result == 'success' || needs.football-bundesliga.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'football' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 10

      - name: Collect Ligue 1
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-football?league=FL1" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

  football-generate-analysis:
    name: Football - Generate Analysis
    runs-on: ubuntu-latest
    needs: [football-ligue1]
    if: |
      always() &&
      (needs.football-ligue1.result == 'success' || needs.football-ligue1.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'football' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 15

      - name: Generate Football Analysis (batch calls)
        run: |
          TOTAL=0
          for i in 1 2 3 4 5; do
            echo "ðŸ”„ Batch $i/5..."
            RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/generate-analysis?sport=football" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              --fail --show-error --max-time 120) || true
            echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
            GENERATED=$(echo "$RESPONSE" | jq -r '.analysesGenerated // 0')
            TOTAL=$((TOTAL + GENERATED))
            if [ "$GENERATED" = "0" ]; then
              echo "âœ… No more matches to analyze"
              break
            fi
            echo "âœ… Batch $i: Generated $GENERATED analyses"
            sleep 5
          done
          echo "ðŸ“Š Total analyses generated: $TOTAL"

  football-generate-daily-report:
    name: Football - Generate Daily Report
    runs-on: ubuntu-latest
    needs: [football-generate-analysis]
    if: |
      always() &&
      (needs.football-generate-analysis.result == 'success' || needs.football-generate-analysis.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'football' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 15

      - name: Generate Football Daily Report (batch calls)
        run: |
          # ì˜¤ëŠ˜/ë‚´ì¼ ê°ê° ë³„ë„ í˜¸ì¶œ (íƒ€ìž„ì•„ì›ƒ ë°©ì§€)
          for i in 1 2; do
            echo "ðŸ”„ Daily Report Call $i/2..."
            RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/generate-daily-report?sport=football" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              --max-time 300) || true
            echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

            # ê²°ê³¼ í™•ì¸
            DATE=$(echo "$RESPONSE" | jq -r '.results[0].date // "unknown"')
            MESSAGE=$(echo "$RESPONSE" | jq -r '.results[0].message // "created"')
            echo "âœ… Call $i: $DATE - $MESSAGE"

            # ì´ë¯¸ ì¡´ìž¬í•˜ëŠ” ë¦¬í¬íŠ¸ë©´ ë‹¤ìŒ í˜¸ì¶œì—ì„œ ë‹¤ë¥¸ ë‚ ì§œ ì²˜ë¦¬ë¨
            sleep 5
          done
          echo "ðŸ“Š Daily report generation complete"

  # =====================================================
  # BASKETBALL JOBS (Football ì™„ë£Œ í›„ ì‹¤í–‰)
  # =====================================================
  basketball-collect-matches:
    name: Basketball - Collect Matches
    runs-on: ubuntu-latest
    needs: [football-generate-daily-report]
    if: |
      always() &&
      (needs.football-generate-daily-report.result == 'success' || needs.football-generate-daily-report.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'basketball' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Collect Basketball Matches
        id: collect
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-basketball" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

  basketball-generate-analysis:
    name: Basketball - Generate Analysis
    runs-on: ubuntu-latest
    needs: [basketball-collect-matches]
    if: |
      always() &&
      (needs.basketball-collect-matches.result == 'success' || needs.basketball-collect-matches.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'basketball' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 15

      - name: Generate Basketball Analysis (batch calls)
        id: analysis
        run: |
          TOTAL=0
          for i in 1 2 3 4 5; do
            echo "ðŸ”„ Batch $i/5..."
            RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/generate-analysis?sport=basketball" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              --fail --show-error --max-time 120) || true
            echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
            GENERATED=$(echo "$RESPONSE" | jq -r '.analysesGenerated // 0')
            TOTAL=$((TOTAL + GENERATED))
            if [ "$GENERATED" = "0" ]; then
              echo "âœ… No more matches to analyze"
              break
            fi
            echo "âœ… Batch $i: Generated $GENERATED analyses"
            sleep 5
          done
          echo "ðŸ“Š Total analyses generated: $TOTAL"

  basketball-generate-daily-report:
    name: Basketball - Generate Daily Report
    runs-on: ubuntu-latest
    needs: [basketball-generate-analysis]
    if: |
      always() &&
      (needs.basketball-generate-analysis.result == 'success' || needs.basketball-generate-analysis.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'basketball' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 15

      - name: Generate Basketball Daily Report (batch calls)
        id: report
        run: |
          # ì˜¤ëŠ˜/ë‚´ì¼ ê°ê° ë³„ë„ í˜¸ì¶œ (íƒ€ìž„ì•„ì›ƒ ë°©ì§€)
          for i in 1 2; do
            echo "ðŸ”„ Daily Report Call $i/2..."
            RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/generate-daily-report?sport=basketball" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              --max-time 300) || true
            echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

            DATE=$(echo "$RESPONSE" | jq -r '.results[0].date // "unknown"')
            MESSAGE=$(echo "$RESPONSE" | jq -r '.results[0].message // "created"')
            echo "âœ… Call $i: $DATE - $MESSAGE"
            sleep 5
          done
          echo "ðŸ“Š Daily report generation complete"

  # =====================================================
  # BASEBALL JOBS (Basketball ì™„ë£Œ í›„ ì‹¤í–‰)
  # =====================================================
  baseball-collect-matches:
    name: Baseball - Collect Matches
    runs-on: ubuntu-latest
    needs: [basketball-generate-daily-report]
    if: |
      always() &&
      (needs.basketball-generate-daily-report.result == 'success' || needs.basketball-generate-daily-report.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'baseball' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Collect Baseball Matches
        id: collect
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/collect-baseball" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
          # ì˜¤í”„ì‹œì¦Œ ì²´í¬
          OFF_SEASON=$(echo "$RESPONSE" | jq -r '.offSeason // false')
          if [ "$OFF_SEASON" = "true" ]; then
            echo "âš¾ MLB is in off-season (Nov-Mar). Skipping data collection."
          else
            ADDED=$(echo "$RESPONSE" | jq -r '.results.matchesAdded // 0')
            UPDATED=$(echo "$RESPONSE" | jq -r '.results.matchesUpdated // 0')
            echo "âœ… Collected $ADDED new matches, updated $UPDATED matches"
          fi
          echo "off_season=$OFF_SEASON" >> $GITHUB_OUTPUT

  baseball-generate-analysis:
    name: Baseball - Generate Analysis
    runs-on: ubuntu-latest
    needs: [baseball-collect-matches]
    if: |
      always() &&
      (needs.baseball-collect-matches.result == 'success' || needs.baseball-collect-matches.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'baseball' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 15

      - name: Generate Baseball Analysis
        run: |
          RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/generate-analysis?sport=baseball" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --fail --show-error)
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
          GENERATED=$(echo "$RESPONSE" | jq -r '.analysesGenerated // 0')
          if [ "$GENERATED" = "0" ]; then
            echo "â„¹ï¸ No matches requiring analysis in next 48 hours"
          else
            echo "âœ… Generated $GENERATED analyses"
          fi

  baseball-generate-daily-report:
    name: Baseball - Generate Daily Report
    runs-on: ubuntu-latest
    needs: [baseball-generate-analysis]
    if: |
      always() &&
      (needs.baseball-generate-analysis.result == 'success' || needs.baseball-generate-analysis.result == 'skipped') &&
      (
        github.event_name == 'workflow_dispatch' &&
        (github.event.inputs.sport == 'baseball' || github.event.inputs.sport == 'all') ||
        github.event_name == 'schedule'
      )
    steps:
      - name: Wait for rate limit
        run: sleep 15

      - name: Generate Baseball Daily Report (batch calls)
        run: |
          # ì˜¤ëŠ˜/ë‚´ì¼ ê°ê° ë³„ë„ í˜¸ì¶œ (íƒ€ìž„ì•„ì›ƒ ë°©ì§€)
          for i in 1 2; do
            echo "ðŸ”„ Daily Report Call $i/2..."
            RESPONSE=$(curl -X GET "${{ secrets.SITE_URL }}/api/cron/generate-daily-report?sport=baseball" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -H "Content-Type: application/json" \
              --max-time 300) || true
            echo "$RESPONSE" | jq '.' || echo "$RESPONSE"

            DATE=$(echo "$RESPONSE" | jq -r '.results[0].date // "unknown"')
            MESSAGE=$(echo "$RESPONSE" | jq -r '.results[0].message // "created"')
            echo "âœ… Call $i: $DATE - $MESSAGE"
            sleep 5
          done
          echo "ðŸ“Š Daily report generation complete"

  # =====================================================
  # SUMMARY
  # =====================================================
  notify-completion:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs:
      - football-pl
      - football-laliga
      - football-seriea
      - football-bundesliga
      - football-ligue1
      - football-generate-analysis
      - football-generate-daily-report
      - basketball-collect-matches
      - basketball-generate-analysis
      - basketball-generate-daily-report
      - baseball-collect-matches
      - baseball-generate-analysis
      - baseball-generate-daily-report
    if: always()
    steps:
      - name: Summary
        run: |
          echo "# ðŸŸï¸ Data Collection Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš½ Football (by League)" >> $GITHUB_STEP_SUMMARY
          echo "- Premier League: ${{ needs.football-pl.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- La Liga: ${{ needs.football-laliga.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Serie A: ${{ needs.football-seriea.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bundesliga: ${{ needs.football-bundesliga.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ligue 1: ${{ needs.football-ligue1.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Generate Analysis: ${{ needs.football-generate-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Generate Daily Report: ${{ needs.football-generate-daily-report.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ€ Basketball" >> $GITHUB_STEP_SUMMARY
          echo "- Collect Matches: ${{ needs.basketball-collect-matches.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Generate Analysis: ${{ needs.basketball-generate-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Generate Daily Report: ${{ needs.basketball-generate-daily-report.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš¾ Baseball" >> $GITHUB_STEP_SUMMARY
          echo "- Collect Matches: ${{ needs.baseball-collect-matches.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Generate Analysis: ${{ needs.baseball-generate-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Generate Daily Report: ${{ needs.baseball-generate-daily-report.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
